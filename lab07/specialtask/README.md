Задание:

Скачать демо-версию Atlassian Jira и переписать основной скрипт запуска на unit-файл. Выполнить с использованием [Vagrantfile](Vagrantfile) и [proviosioner shell](provision.sh)(комментарии присутствуют).


Описание решения:

Основной скрипт запуска Atlassian Jira представляет собою несколько bash-скриптов, задачей которых является собрать данные об окружении, в котором будет запускаться приложение и передать эти данные как опции приложению java. Для того, чтобы обеспечить минимальное вмешательство при максимальной остаточной функциональности скриптов, мною было принято решение внести изменения в оконечную часть скрипта [catalina.sh](catalina.sh), а именно:
* теперь скрипт не запускает jira - только отправляет собранную информацию об окружении в EnvironmentFile, который впоследствии используется systemd;
* из скрипта убрана логика отслеживания PID, т.к. теперь эта логика лежит на systemd;
* из скрипта убрана логика debug, run, stop и пр., т.к. теперь она не нужна, но ею всегда можно будет воспользоваться из резервной копии скрипта, которая создается при развёртывании;


Особенности реализации:

Поскольку в systemd EnvironmentFile читается один раз перед стартом сервиса, не имеет смысла помещать логику сканирования окружения в основной service-файл. Также не имеет смысла передавать переменные окружения через systemctl set-environment, т.к. нужны права root, а давать такой уровень полномочий пользователю jira опасно. Также манипуляции с export из пространства одного пользователя в пространство другого требуют административных прав, которых у скрипта нет. В итоге, было принято решение разделить процессы сканирования окружения и запуска jira на 2 сервиса:
* Сервис [jira-pre](jira-pre.service) (oneshot, disabled) - вызывает группу скриптов которые сканируют окружение и помещают его в файл /etc/sysconfig/jiraenv;
* Сервис [jira](jira.service) (simple, enabled) - вызывается после того, как поднимется сеть, nginx и postgresql и сам вызывает сервис jira-pre, одновременно ожидая 5 секунд, пока тот закончит работу, а после запускается, передав программе java группу переменных, которые были получены сервисом jira-pre. Этот же набор переменных используется для остановки jira.


P.S. Нормальный код выхода из JVM - 143, что также учтено в service-файле.

P.P.S. Здесь Jira развертывается с nginx и postgresql. После загрузки можно посмотреть что там внутри.
